version: '3.8'

services:
  app:
    build:
      context: .
      args:
        - APP_ENV=${APP_ENV:-production}
        - NODE_ENV=${NODE_ENV:-production}
    image: fresta:${IMAGE_TAG:-latest}
    container_name: fresta-${IMAGE_TAG:-prod}
    restart: always
    environment:
      - APP_ENV=${APP_ENV:-production}
      - NODE_ENV=${NODE_ENV:-production}
    # Mantemos a porta para acesso direto se necess√°rio
    ports:
      - "${PORT_MAP:-8080}:80"
    networks:
      - fresta-network
      - ${TRAEFIK_NETWORK:-traefik}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.fresta-${IMAGE_TAG}.rule=Host(`${DOMAIN_NAME:-localhost}`)"
      - "traefik.http.routers.fresta-${IMAGE_TAG}.entrypoints=web,websecure"
      - "traefik.http.routers.fresta-${IMAGE_TAG}.tls=true"
      - "traefik.http.routers.fresta-${IMAGE_TAG}.tls.certresolver=mytlschallenge"
      - "traefik.docker.network=traefik"
      - "traefik.http.services.fresta-${IMAGE_TAG}.loadbalancer.server.port=80"

networks:
  fresta-network:
    driver: bridge
  traefik:
    external: true
  proxy:
    external: true
